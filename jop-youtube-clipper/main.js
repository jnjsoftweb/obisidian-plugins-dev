/*
THIS IS A GENERATED/BUNDLED FILE BY ESBUILD
*/

"use strict";

// main.js
var { Plugin, Notice, PluginSettingTab, Setting } = require("obsidian");
var DEFAULT_SETTINGS = {
  saveFolder: "10. Clippings",
  apiSummaryUrl: "https://n8n.bigwhiteweb.com/webhook/youtube-summary",
  apiInfoUrl: "https://n8n.bigwhiteweb.com/webhook/youtube-info"
};
var YouTubeTranscriptPlugin = class extends Plugin {
  async onload() {
    await this.loadSettings();
    console.log("YouTube Clipper í”ŒëŸ¬ê·¸ì¸ì´ ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤.");
    this.addSettingTab(new YouTubeTranscriptSettingTab(this.app, this));
    this.addCommand({
      id: "save-youtube-clipper",
      name: "Save YouTube Clipper",
      callback: () => this.saveTranscript(),
    });
    this.addCommand({
      id: "save-all-youtube-clipper",
      name: "Save All YouTube Clipper from Current Note",
      editorCallback: async (editor) => {
        const content = editor.getValue();
        await this.saveAllTranscripts(content);
      },
    });
  }
  onunload() {
    console.log("YouTube Clipper í”ŒëŸ¬ê·¸ì¸ì´ ì–¸ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤.");
  }
  async loadSettings() {
    this.settings = Object.assign({}, DEFAULT_SETTINGS, await this.loadData());
  }
  async saveSettings() {
    await this.saveData(this.settings);
  }
  normalizeYouTubeUrl(url) {
    try {
      // youtu.be í˜•ì‹ì˜ URL ì²˜ë¦¬
      if (url.includes("youtu.be/")) {
        const videoId = url.split("youtu.be/")[1].split("?")[0];
        return `https://www.youtube.com/watch?v=${videoId}`;
      }

      // ì´ë¯¸ í‘œì¤€ í˜•ì‹ì¸ ê²½ìš°
      if (url.includes("youtube.com/watch?v=")) {
        return url;
      }

      return null;
    } catch (error) {
      console.error("URL ë³€í™˜ ì˜¤ë¥˜:", error);
      return null;
    }
  }
  async saveTranscript() {
    try {
      const clipText = await navigator.clipboard.readText();
      const normalizedUrl = this.normalizeYouTubeUrl(clipText);

      if (!normalizedUrl) {
        new Notice("ìœ íš¨í•œ YouTube URLì´ í´ë¦½ë³´ë“œì— ì—†ìŠµë‹ˆë‹¤.");
        return;
      }

      const videoId = new URLSearchParams(new URL(normalizedUrl).search).get("v");
      if (!videoId) {
        new Notice("ë™ì˜ìƒ IDë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
        return;
      }

      new Notice("ìë§‰ì„ ë¶„ì„í•˜ê³  ìˆìŠµë‹ˆë‹¤...");
      
      // API ì‘ë‹µ í™•ì¸ì„ ìœ„í•œ ë¡œê¹… ì¶”ê°€
      try {
        const [transcriptResponse, infoResponse] = await Promise.all([
          this.fetchWithTimeout(`${this.settings.apiSummaryUrl}?videoId=${videoId}`),
          this.fetchWithTimeout(`${this.settings.apiInfoUrl}?videoId=${videoId}`),
        ]);

        // ì‘ë‹µ ìƒíƒœ í™•ì¸ ë° ìì„¸í•œ ì—ëŸ¬ ë©”ì‹œì§€
        if (!transcriptResponse.ok) {
          const errorText = await transcriptResponse.text();
          console.error("Transcript API ì˜¤ë¥˜:", errorText);
          throw new Error(`ìë§‰ ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. (ìƒíƒœ ì½”ë“œ: ${transcriptResponse.status})`);
        }

        if (!infoResponse.ok) {
          const errorText = await infoResponse.text();
          console.error("Info API ì˜¤ë¥˜:", errorText);
          throw new Error(`ë™ì˜ìƒ ì •ë³´ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. (ìƒíƒœ ì½”ë“œ: ${infoResponse.status})`);
        }

        const [transcriptData, infoData] = await Promise.all([
          transcriptResponse.json(),
          infoResponse.json()
        ]);

        // ì‘ë‹µ ë°ì´í„° ìœ íš¨ì„± ê²€ì‚¬
        if (!transcriptData || !transcriptData.content) {
          console.error("ì˜ëª»ëœ ìë§‰ ë°ì´í„°:", transcriptData);
          throw new Error("ìë§‰ ë°ì´í„°ê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.");
        }

        if (!infoData || !infoData.info) {
          console.error("ì˜ëª»ëœ ë™ì˜ìƒ ì •ë³´:", infoData);
          throw new Error("ë™ì˜ìƒ ì •ë³´ê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.");
        }

        // íƒœê·¸ ì¶”ì¶œ ë° ì²˜ë¦¬
        const tagMatch = transcriptData.content.match(/## tags:\n(.*?)\n\n/s);
        const additionalTags = tagMatch
          ? tagMatch[1].split(", ").map(
              (tag) => tag.replace(/\s+/g, "").replace("[", "").replace("]", "") // ê³µë°± ì œê±°, '[]' ì œê±°
            )
          : [];

        const content =
          this.formatVideoMetadata(infoData.info, videoId, additionalTags) +
          "\n## description\n\n" +
          infoData.info.description +
          "\n\n\n## summary\n" +
          transcriptData.content.match(/## summary:\n(.*?)\n\n\n## content:/s)[1].replace(/\n{3,}/g, "\n\n") +
          "\n\n\n## content\n" +
          transcriptData.content.match(/## content:\n(.*?)$/s)[1].replace(/\n{3,}/g, "\n\n");

        const safeTitle = this.sanitizeName(infoData.info.title);
        const fileName = `${safeTitle}.md`;
        const filePath = this.settings.saveFolder ? `${this.settings.saveFolder}/${fileName}` : fileName;

        if (this.settings.saveFolder) {
          try {
            if (!(await this.app.vault.adapter.exists(this.settings.saveFolder))) {
              await this.app.vault.createFolder(this.settings.saveFolder);
            }
          } catch (err) {
            console.error("í´ë” ìƒì„± ì˜¤ë¥˜:", err);
          }
        }

        await this.app.vault.create(filePath, content);
        new Notice(`ìë§‰ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤: ${fileName}`);
      } catch (apiError) {
        console.error("API ìš”ì²­ ì˜¤ë¥˜:", apiError);
        throw new Error(`API ìš”ì²­ ì‹¤íŒ¨: ${apiError.message}`);
      }

    } catch (error) {
      console.error("Error:", error);
      new Notice(`ìë§‰ ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ${error.message}`);
    }
  }
  async fetchWithTimeout(url, timeout = 180000) {
    const controller = new AbortController();
    const timeoutId = setTimeout(() => controller.abort(), timeout);
    try {
      const response = await fetch(url, {
        signal: controller.signal,
        headers: {
          Accept: "application/json",
          "Content-Type": "application/json",
        },
      });
      clearTimeout(timeoutId);
      return response;
    } catch (error) {
      clearTimeout(timeoutId);
      if (error.name === "AbortError") {
        throw new Error("ìš”ì²­ ì‹œê°„ì´ ì´ˆê³¼ë˜ì—ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.");
      }
      throw error;
    }
  }
  formatVideoMetadata(info, videoId, additionalTags = []) {
    const today = new Date().toISOString().split("T")[0];
    const published = new Date(info.published).toISOString().split("T")[0];
    const duration = info.duration.replace("PT", "").replace("H", ":").replace("M", ":").replace("S", "");
    const durationParts = duration.split(":");
    let formattedDuration = "";
    if (durationParts.length === 3) {
      formattedDuration = durationParts.map((part) => part.padStart(2, "0")).join(":");
    } else if (durationParts.length === 2) {
      formattedDuration = durationParts.map((part) => part.padStart(2, "0")).join(":");
    } else {
      formattedDuration = `00:${durationParts[0].padStart(2, "0")}`;
    }

    // ê¸°ë³¸ íƒœê·¸ì™€ ì¶”ê°€ íƒœê·¸ ê²°í•©
    const allTags = ["clippings/youtube", ...additionalTags];
    const formattedTags = allTags.map((tag) => `  - ${tag}`).join("\n");

    const safeTitle = this.sanitizeName(info.title);
    const youtubeUrl = `https://www.youtube.com/watch?v=${videoId}`;
    
    // ë¦¬ë·° íŒŒì¼ ìƒì„±
    this.createReviewFile(safeTitle, youtubeUrl);

    return `---
title: ${info.title}
author: [[${info.channelTitle}]]
source: ${youtubeUrl}
created: ${today}
published: ${published}
thumbnail: ${info.thumbnail}
duration: ${formattedDuration}
channelId: ${info.channelId}
viewCount: ${info.viewCount}
likeCount: ${info.likeCount}
categoryId: ${info.categoryId}
tags:
${formattedTags}
---

![${info.title}](${youtubeUrl})

## review

[[${safeTitle}_review|ğŸ“ ë¦¬ë·° ì‘ì„±]]

`;
  }
  sanitizeName(name) {
    return name
      .replace(/\[/g, "(")
      .replace(/\]/g, ")")
      .replace(/[^\uAC00-\uD7A3a-zA-Z0-9_\(\)\<\>\s]/g, "")
      .replace(/\s+/g, " ")
      .trim();
  }
  async saveAllTranscripts(content) {
    try {
      // YouTube URL íŒ¨í„´ (youtu.be í˜•ì‹ê³¼ @ ê¸°í˜¸ë¡œ ì‹œì‘í•˜ëŠ” URL í¬í•¨)
      const urlPattern = /@?https?:\/\/((?:www\.)?youtube\.com\/watch\?v=|youtu\.be\/)[a-zA-Z0-9_-]+(?:[?&][^\\s]*)?/g;
      const urls = content.match(urlPattern);

      if (!urls || urls.length === 0) {
        new Notice("í˜„ì¬ ë…¸íŠ¸ì—ì„œ YouTube URLì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
        return;
      }

      // URL ì •ê·œí™” (@ ê¸°í˜¸ ì œê±° ë° í‘œì¤€ í˜•ì‹ìœ¼ë¡œ ë³€í™˜)
      const normalizedUrls = urls
        .map((url) => url.replace(/^@/, "")) // @ ê¸°í˜¸ ì œê±°
        .map((url) => this.normalizeYouTubeUrl(url))
        .filter((url) => url !== null);

      if (normalizedUrls.length === 0) {
        new Notice("ì²˜ë¦¬ ê°€ëŠ¥í•œ YouTube URLì´ ì—†ìŠµë‹ˆë‹¤.");
        return;
      }

      new Notice(`${normalizedUrls.length}ê°œì˜ YouTube URLì„ ì°¾ì•˜ìŠµë‹ˆë‹¤. ì²˜ë¦¬ë¥¼ ì‹œì‘í•©ë‹ˆë‹¤...`);

      for (let i = 0; i < normalizedUrls.length; i++) {
        const url = normalizedUrls[i];
        const videoId = new URLSearchParams(new URL(url).search).get("v");

        if (!videoId) continue;

        try {
          new Notice(`(${i + 1}/${normalizedUrls.length}) ìë§‰ì„ ë¶„ì„í•˜ê³  ìˆìŠµë‹ˆë‹¤...`);

          const [transcriptResponse, infoResponse] = await Promise.all([
            this.fetchWithTimeout(`${this.settings.apiSummaryUrl}?videoId=${videoId}`),
            this.fetchWithTimeout(`${this.settings.apiInfoUrl}?videoId=${videoId}`),
          ]);

          if (!transcriptResponse.ok || !infoResponse.ok) {
            console.error(`URL ì²˜ë¦¬ ì‹¤íŒ¨: ${url}`);
            continue;
          }

          const [transcriptData, infoData] = await Promise.all([transcriptResponse.json(), infoResponse.json()]);

          if (!transcriptData.content || !infoData.info) {
            console.error(`ë°ì´í„° ì—†ìŒ: ${url}`);
            continue;
          }

          const content = this.formatVideoMetadata(infoData.info, videoId) + transcriptData.content;
          // const content = this.formatVideoMetadata(infoData.info, videoId) + "\n## Content\n" + transcriptData.content;

          const safeTitle = this.sanitizeName(infoData.info.title);
          const fileName = `${safeTitle}.md`;
          const filePath = this.settings.saveFolder ? `${this.settings.saveFolder}/${fileName}` : fileName;

          if (this.settings.saveFolder) {
            try {
              if (!(await this.app.vault.adapter.exists(this.settings.saveFolder))) {
                await this.app.vault.createFolder(this.settings.saveFolder);
              }
            } catch (err) {
              console.error("í´ë” ìƒì„± ì˜¤ë¥˜:", err);
            }
          }

          await this.app.vault.create(filePath, content);
          new Notice(`(${i + 1}/${normalizedUrls.length}) ì €ì¥ ì™„ë£Œ: ${fileName}`);

          await new Promise((resolve) => setTimeout(resolve, 1000));
        } catch (error) {
          console.error(`URL ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: ${url}`, error);
          new Notice(`URL ì²˜ë¦¬ ì‹¤íŒ¨: ${url}`);
        }
      }

      new Notice("ëª¨ë“  YouTube ìë§‰ ì €ì¥ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.");
    } catch (error) {
      console.error("Error:", error);
      new Notice("ìë§‰ ì¼ê´„ ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: " + error.message);
    }
  }
  async createReviewFile(noteName, sourceUrl) {
    try {
        // Review í´ë” ê²½ë¡œ ìƒì„±
        const reviewFolderPath = this.settings.saveFolder 
            ? `${this.settings.saveFolder}/Reviews`
            : 'Reviews';
            
        // Review í´ë”ê°€ ì—†ìœ¼ë©´ ìƒì„±
        if (!(await this.app.vault.adapter.exists(reviewFolderPath))) {
            await this.app.vault.createFolder(reviewFolderPath);
        }

        const reviewFileName = `${noteName}_review.md`;
        const reviewFilePath = `${reviewFolderPath}/${reviewFileName}`;

        // í…œí”Œë¦¿ íŒŒì¼ ê²½ë¡œ ìˆ˜ì •
        const templatePath = `${this.app.vault.configDir}/templates/review.md`;
        console.log(templatePath);
        
        let templateContent;
        try {
            templateContent = await this.app.vault.adapter.read(templatePath);
        } catch (error) {
            // í…œí”Œë¦¿ íŒŒì¼ì´ ì—†ëŠ” ê²½ìš° ê¸°ë³¸ í…œí”Œë¦¿ ì‚¬ìš©
            templateContent = `---
title: 
source: 
viewCount: 0
difficulty: 3
likeability: 3
tags:
  - review/youtube
---

### ì›ë³¸

![youtube ë™ì˜ìƒ]()

[[Clipping ì›ë³¸]]



### ì •ë¦¬/ìš”ì•½




### 3ì¤„í‰



`;
        }
        
        // í…œí”Œë¦¿ ë‚´ìš© ì¹˜í™˜
        const reviewContent = templateContent
            .replace('title: ', `title: ${noteName}`)
            .replace('source: ', `source: ${sourceUrl}`)
            .replace('![youtube ë™ì˜ìƒ]()', `![youtube ë™ì˜ìƒ](${sourceUrl})`)
            .replace('[[Clipping ì›ë³¸]]', `[[${noteName}|Clipping ì›ë³¸]]`);

        // ë¦¬ë·° íŒŒì¼ ìƒì„±
        if (!(await this.app.vault.adapter.exists(reviewFilePath))) {
            await this.app.vault.create(reviewFilePath, reviewContent);
        }
    } catch (error) {
        console.error('ë¦¬ë·° íŒŒì¼ ìƒì„± ì¤‘ ì˜¤ë¥˜:', error);
        new Notice('ë¦¬ë·° íŒŒì¼ ìƒì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
    }
  }
};
var YouTubeTranscriptSettingTab = class extends PluginSettingTab {
  constructor(app, plugin) {
    super(app, plugin);
    this.plugin = plugin;
  }
  display() {
    const { containerEl } = this;
    containerEl.empty();
    containerEl.createEl("h2", { text: "YouTube Clipper ì„¤ì •" });
    
    new Setting(containerEl)
      .setName("ì €ì¥ í´ë”")
      .setDesc("ìë§‰ íŒŒì¼ì´ ì €ì¥ë  í´ë” ê²½ë¡œë¥¼ ì§€ì •í•©ë‹ˆë‹¤.")
      .addText((text) =>
        text
          .setPlaceholder("ì˜ˆ: YouTube Clipper")
          .setValue(this.plugin.settings.saveFolder)
          .onChange(async (value) => {
            this.plugin.settings.saveFolder = value;
            await this.plugin.saveSettings();
          })
      );

    new Setting(containerEl)
      .setName("ìš”ì•½ API URL")
      .setDesc("YouTube ìë§‰ ìš”ì•½ APIì˜ URLì„ ì§€ì •í•©ë‹ˆë‹¤.")
      .addText((text) =>
        text
          .setPlaceholder("ì˜ˆ: https://api.example.com/youtube-summary")
          .setValue(this.plugin.settings.apiSummaryUrl)
          .onChange(async (value) => {
            this.plugin.settings.apiSummaryUrl = value;
            await this.plugin.saveSettings();
          })
      );

    new Setting(containerEl)
      .setName("ì •ë³´ API URL")
      .setDesc("YouTube ë™ì˜ìƒ ì •ë³´ APIì˜ URLì„ ì§€ì •í•©ë‹ˆë‹¤.")
      .addText((text) =>
        text
          .setPlaceholder("ì˜ˆ: https://api.example.com/youtube-info")
          .setValue(this.plugin.settings.apiInfoUrl)
          .onChange(async (value) => {
            this.plugin.settings.apiInfoUrl = value;
            await this.plugin.saveSettings();
          })
      );
  }
};
module.exports = YouTubeTranscriptPlugin;
